# Task 2

```sql

WITH TMP_T
AS
(
select TSS.NAME SUBSCRIPTION, 
    trunc(tsuf.START_DTM, 'YYYY')      AS YEAR,
    TO_CHAR(tsuf.START_DTM, 'MM')      AS MONTH,
    'MONTH' PERIOD,
    SUM(tsuf.PAYMENT) AS PROFIT_BY_MOUNTH
  
    from U_DW_SUBSTRICTIONS.T_SUBSCRIPTIONS_USER_F tsuf 
    inner join 
    (SELECT *
    FROM
    U_DW_SUBSTRICTIONS.T_SUBSCRIPTIONS TS
    INNER JOIN 
    U_DW_SUBSTRICTIONS.T_SUBSCRIPTIONS_NAME TSN
    ON 
    TS.ID_SUBSCRIPTIONS_NAME=TSN.ID_SUBSCRIPTIONS_NAME)
    TSS 
    on 
    tsuf.ID_SUBSCRIPTIONS=TSS.ID_SUBSCRIPTIONS
    GROUP BY 
        TSS.NAME, 
        trunc(tsuf.START_DTM, 'YYYY'),
         TO_CHAR(tsuf.START_DTM, 'MM') 
    ORDER BY 
    SUBSCRIPTION, 
    YEAR,
    MONTH
)

SELECT
    SUBSCRIPTION, 
    YEAR,
    MONTH,
    PERIOD,
    PROFIT_BY_MOUNTH
FROM
TMP_T
 MODEL 
    PARTITION BY (SUBSCRIPTION)
    DIMENSION BY (YEAR, MONTH, PERIOD)
    MEASURES (PROFIT_BY_MOUNTH)
    RULES (
        PROFIT_BY_MOUNTH[FOR YEAR IN (SELECT DISTINCT YEAR FROM TMP_T), NULL, 'YEAR'] = SUM(PROFIT_BY_MOUNTH)[CV(YEAR), ANY, 'MONTH'],
        PROFIT_BY_MOUNTH[NULL, NULL, 'ALL'] = SUM(PROFIT_BY_MOUNTH)[ANY, NULL, 'YEAR']
    )
ORDER BY 
    SUBSCRIPTION,
    YEAR,
    MONTH
    ;
	

```

| SUBSCRIPTION | YEAR | MONTH | PERIOD | PROFIT\_BY\_MOUNTH |
| :--- | :--- | :--- | :--- | :--- |
| MEDIUM | 2021-01-01 00:00:00 | 02 | MONTH | 9638.84 |
| MEDIUM | 2021-01-01 00:00:00 | 03 | MONTH | 10870.22 |
| MEDIUM | 2021-01-01 00:00:00 | 04 | MONTH | 10534.86 |
| MEDIUM | 2021-01-01 00:00:00 | 05 | MONTH | 10870.58 |
| MEDIUM | 2021-01-01 00:00:00 | 06 | MONTH | 10566.46 |
| MEDIUM | 2021-01-01 00:00:00 | 07 | MONTH | 10408.32 |
| MEDIUM | 2021-01-01 00:00:00 | 08 | MONTH | 44028.15 |
| MEDIUM | 2021-01-01 00:00:00 | 09 | MONTH | 43302.88 |
| MEDIUM | 2021-01-01 00:00:00 | 10 | MONTH | 40056.53 |
| MEDIUM | 2021-01-01 00:00:00 | 11 | MONTH | 41907.87 |
| MEDIUM | 2021-01-01 00:00:00 | 12 | MONTH | 41491.3 |
| MEDIUM | 2021-01-01 00:00:00 | NULL | YEAR  | 273676.01 |
| MEDIUM | 2022-01-01 00:00:00 | 01 | MONTH | 40506.13 |
| MEDIUM | 2022-01-01 00:00:00 | 02 | MONTH | 37365.05 |
| MEDIUM | 2022-01-01 00:00:00 | 03 | MONTH | 42350.61 |
| MEDIUM | 2022-01-01 00:00:00 | 04 | MONTH | 39970.61 |
| MEDIUM | 2022-01-01 00:00:00 | 05 | MONTH | 40422.82 |
| MEDIUM | 2022-01-01 00:00:00 | 06 | MONTH | 41553.66 |
| MEDIUM | 2022-01-01 00:00:00 | 07 | MONTH | 42478.08 |
| MEDIUM | 2022-01-01 00:00:00 | NULL | YEAR  | 284646.96 |
| MEDIUM | NULL | NULL | ALL   | 558322.97 |
| PREMIUM | 2021-01-01 00:00:00 | 02 | MONTH | 16344.54 |
| PREMIUM | 2021-01-01 00:00:00 | 03 | MONTH | 17924.04 |
| PREMIUM | 2021-01-01 00:00:00 | 04 | MONTH | 17320 |
| PREMIUM | 2021-01-01 00:00:00 | 05 | MONTH | 18245.19 |
| PREMIUM | 2021-01-01 00:00:00 | 06 | MONTH | 17574.45 |
| PREMIUM | 2021-01-01 00:00:00 | 07 | MONTH | 18722.56 |
| PREMIUM | 2021-01-01 00:00:00 | 08 | MONTH | 23622.88 |
| PREMIUM | 2021-01-01 00:00:00 | 09 | MONTH | 22316 |
| PREMIUM | 2021-01-01 00:00:00 | 10 | MONTH | 26223.18 |
| PREMIUM | 2021-01-01 00:00:00 | 11 | MONTH | 26753.44 |
| PREMIUM | 2021-01-01 00:00:00 | 12 | MONTH | 27983.93 |
| PREMIUM | 2021-01-01 00:00:00 | NULL | YEAR  | 233030.21 |
| PREMIUM | 2022-01-01 00:00:00 | 01 | MONTH | 27260.05 |
| PREMIUM | 2022-01-01 00:00:00 | 02 | MONTH | 24748.56 |
| PREMIUM | 2022-01-01 00:00:00 | 03 | MONTH | 80368.4 |
| PREMIUM | 2022-01-01 00:00:00 | 04 | MONTH | 80750.82 |
| PREMIUM | 2022-01-01 00:00:00 | 05 | MONTH | 84404.56 |
| PREMIUM | 2022-01-01 00:00:00 | 06 | MONTH | 80842.49 |
| PREMIUM | 2022-01-01 00:00:00 | 07 | MONTH | 84010.79 |
| PREMIUM | 2022-01-01 00:00:00 | NULL | YEAR  | 462385.67 |
| PREMIUM | NULL | NULL | ALL   | 695415.88 |
| START | 2021-01-01 00:00:00 | 02 | MONTH | 14230.57 |
| START | 2021-01-01 00:00:00 | 03 | MONTH | 15222.89 |
| START | 2021-01-01 00:00:00 | 04 | MONTH | 14889.73 |
| START | 2021-01-01 00:00:00 | 05 | MONTH | 15270.85 |
| START | 2021-01-01 00:00:00 | 06 | MONTH | 14575.55 |
| START | 2021-01-01 00:00:00 | 07 | MONTH | 14939.44 |
| START | 2021-01-01 00:00:00 | 08 | MONTH | 123756.73 |
| START | 2021-01-01 00:00:00 | 09 | MONTH | 119443.56 |
| START | 2021-01-01 00:00:00 | 10 | MONTH | 7123.82 |
| START | 2021-01-01 00:00:00 | 11 | MONTH | 7057.5 |
| START | 2021-01-01 00:00:00 | 12 | MONTH | 7321.34 |
| START | 2021-01-01 00:00:00 | NULL | YEAR  | 353831.98 |
| START | 2022-01-01 00:00:00 | 01 | MONTH | 7432.29 |
| START | 2022-01-01 00:00:00 | 02 | MONTH | 6632.83 |
| START | 2022-01-01 00:00:00 | 03 | MONTH | 7243.57 |
| START | 2022-01-01 00:00:00 | 04 | MONTH | 7186.25 |
| START | 2022-01-01 00:00:00 | 05 | MONTH | 7281.69 |
| START | 2022-01-01 00:00:00 | 06 | MONTH | 7224.66 |
| START | 2022-01-01 00:00:00 | 07 | MONTH | 7414.92 |
| START | 2022-01-01 00:00:00 | NULL | YEAR  | 50416.21 |
| START | NULL | NULL | ALL   | 404248.19 |
| YEAR | 2021-01-01 00:00:00 | 02 | MONTH | 50144.72 |
| YEAR | 2021-01-01 00:00:00 | 03 | MONTH | 56049.72 |
| YEAR | 2021-01-01 00:00:00 | 04 | MONTH | 53807.41 |
| YEAR | 2021-01-01 00:00:00 | 05 | MONTH | 54908.59 |
| YEAR | 2021-01-01 00:00:00 | 06 | MONTH | 53086.57 |
| YEAR | 2021-01-01 00:00:00 | 07 | MONTH | 54935.11 |
| YEAR | 2021-01-01 00:00:00 | 08 | MONTH | 270026.2 |
| YEAR | 2021-01-01 00:00:00 | 09 | MONTH | 258737.17 |
| YEAR | 2021-01-01 00:00:00 | NULL | YEAR  | 851695.49 |
| YEAR | 2022-01-01 00:00:00 | NULL | YEAR  | NULL |
| YEAR | NULL | NULL | ALL   | 851695.49 |
