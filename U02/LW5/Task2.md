# Task 2

```sql
WITH TMP_T
AS
(
select TSS.NAME SUBSCRIPTION, 
    trunc(tsuf.START_DTM, 'YYYY')      AS YEAR,
    trunc(tsuf.START_DTM, 'MM')      AS MONTH,
    SUM(tsuf.PAYMENT) AS PROFIT_BY_MOUNTH
  
    from U_DW_SUBSTRICTIONS.T_SUBSCRIPTIONS_USER_F tsuf 
    inner join 
    (SELECT *
    FROM
    U_DW_SUBSTRICTIONS.T_SUBSCRIPTIONS TS
    INNER JOIN 
    U_DW_SUBSTRICTIONS.T_SUBSCRIPTIONS_NAME TSN
    ON 
    TS.ID_SUBSCRIPTIONS_NAME=TSN.ID_SUBSCRIPTIONS_NAME)
    TSS 
    on 
    tsuf.ID_SUBSCRIPTIONS=TSS.ID_SUBSCRIPTIONS
    GROUP BY 
        TSS.NAME, 
        trunc(tsuf.START_DTM, 'YYYY'),
        trunc(tsuf.START_DTM, 'MM') 
    ORDER BY 
    SUBSCRIPTION, 
    YEAR,
    MONTH
)

SELECT
    *
FROM
TMP_T
 MODEL 
    PARTITION BY (SUBSCRIPTION)
    DIMENSION BY (YEAR, MONTH)
    MEASURES (PROFIT_BY_MOUNTH)
    RULES (
        PROFIT_BY_MOUNTH[FOR YEAR IN (SELECT DISTINCT YEAR FROM TMP_T), NULL] = SUM(PROFIT_BY_MOUNTH)[CV(YEAR), ANY],
        PROFIT_BY_MOUNTH[NULL, NULL] = SUM(PROFIT_BY_MOUNTH)[ANY, NULL]
    )
ORDER BY 
    SUBSCRIPTION,
    YEAR,
    MONTH
    ;
	
--SUBSCRIPTION|YEAR                   |MONTH                  |PROFIT_BY_MOUNTH|
--------------+-----------------------+-----------------------+----------------+
--MEDIUM      |2021-01-01 00:00:00.000|2021-02-01 00:00:00.000|         9638.84|
--MEDIUM      |2021-01-01 00:00:00.000|2021-03-01 00:00:00.000|        10870.22|
--MEDIUM      |2021-01-01 00:00:00.000|2021-04-01 00:00:00.000|        10534.86|
--MEDIUM      |2021-01-01 00:00:00.000|2021-05-01 00:00:00.000|        10870.58|
--MEDIUM      |2021-01-01 00:00:00.000|2021-06-01 00:00:00.000|        10566.46|
--MEDIUM      |2021-01-01 00:00:00.000|2021-07-01 00:00:00.000|        10408.32|
--MEDIUM      |2021-01-01 00:00:00.000|2021-08-01 00:00:00.000|        44028.15|
--MEDIUM      |2021-01-01 00:00:00.000|2021-09-01 00:00:00.000|        43302.88|
--MEDIUM      |2021-01-01 00:00:00.000|2021-10-01 00:00:00.000|        40056.53|
--MEDIUM      |2021-01-01 00:00:00.000|2021-11-01 00:00:00.000|        41907.87|
--MEDIUM      |2021-01-01 00:00:00.000|2021-12-01 00:00:00.000|         41491.3|
--MEDIUM      |2021-01-01 00:00:00.000|                       |       273676.01|
--MEDIUM      |2022-01-01 00:00:00.000|2022-01-01 00:00:00.000|        40506.13|
--MEDIUM      |2022-01-01 00:00:00.000|2022-02-01 00:00:00.000|        37365.05|
--MEDIUM      |2022-01-01 00:00:00.000|2022-03-01 00:00:00.000|        42350.61|
--MEDIUM      |2022-01-01 00:00:00.000|2022-04-01 00:00:00.000|        39970.61|
--MEDIUM      |2022-01-01 00:00:00.000|2022-05-01 00:00:00.000|        40422.82|
--MEDIUM      |2022-01-01 00:00:00.000|2022-06-01 00:00:00.000|        41553.66|
--MEDIUM      |2022-01-01 00:00:00.000|2022-07-01 00:00:00.000|        42478.08|
--MEDIUM      |2022-01-01 00:00:00.000|                       |       284646.96|
--MEDIUM      |                       |                       |       558322.97|
--PREMIUM     |2021-01-01 00:00:00.000|2021-02-01 00:00:00.000|        16344.54|
--PREMIUM     |2021-01-01 00:00:00.000|2021-03-01 00:00:00.000|        17924.04|
--PREMIUM     |2021-01-01 00:00:00.000|2021-04-01 00:00:00.000|           17320|
--PREMIUM     |2021-01-01 00:00:00.000|2021-05-01 00:00:00.000|        18245.19|
--PREMIUM     |2021-01-01 00:00:00.000|2021-06-01 00:00:00.000|        17574.45|
--PREMIUM     |2021-01-01 00:00:00.000|2021-07-01 00:00:00.000|        18722.56|
--PREMIUM     |2021-01-01 00:00:00.000|2021-08-01 00:00:00.000|        23622.88|
--PREMIUM     |2021-01-01 00:00:00.000|2021-09-01 00:00:00.000|           22316|
--PREMIUM     |2021-01-01 00:00:00.000|2021-10-01 00:00:00.000|        26223.18|
--PREMIUM     |2021-01-01 00:00:00.000|2021-11-01 00:00:00.000|        26753.44|
--PREMIUM     |2021-01-01 00:00:00.000|2021-12-01 00:00:00.000|        27983.93|
--PREMIUM     |2021-01-01 00:00:00.000|                       |       233030.21|
--PREMIUM     |2022-01-01 00:00:00.000|2022-01-01 00:00:00.000|        27260.05|
--PREMIUM     |2022-01-01 00:00:00.000|2022-02-01 00:00:00.000|        24748.56|
--PREMIUM     |2022-01-01 00:00:00.000|2022-03-01 00:00:00.000|         80368.4|
--PREMIUM     |2022-01-01 00:00:00.000|2022-04-01 00:00:00.000|        80750.82|
--PREMIUM     |2022-01-01 00:00:00.000|2022-05-01 00:00:00.000|        84404.56|
--PREMIUM     |2022-01-01 00:00:00.000|2022-06-01 00:00:00.000|        80842.49|
--PREMIUM     |2022-01-01 00:00:00.000|2022-07-01 00:00:00.000|        84010.79|
--PREMIUM     |2022-01-01 00:00:00.000|                       |       462385.67|
--PREMIUM     |                       |                       |       695415.88|
--START       |2021-01-01 00:00:00.000|2021-02-01 00:00:00.000|        14230.57|
--START       |2021-01-01 00:00:00.000|2021-03-01 00:00:00.000|        15222.89|
--START       |2021-01-01 00:00:00.000|2021-04-01 00:00:00.000|        14889.73|
--START       |2021-01-01 00:00:00.000|2021-05-01 00:00:00.000|        15270.85|
--START       |2021-01-01 00:00:00.000|2021-06-01 00:00:00.000|        14575.55|
--START       |2021-01-01 00:00:00.000|2021-07-01 00:00:00.000|        14939.44|
--START       |2021-01-01 00:00:00.000|2021-08-01 00:00:00.000|       123756.73|
--START       |2021-01-01 00:00:00.000|2021-09-01 00:00:00.000|       119443.56|
--START       |2021-01-01 00:00:00.000|2021-10-01 00:00:00.000|         7123.82|
--START       |2021-01-01 00:00:00.000|2021-11-01 00:00:00.000|          7057.5|
--START       |2021-01-01 00:00:00.000|2021-12-01 00:00:00.000|         7321.34|
--START       |2021-01-01 00:00:00.000|                       |       353831.98|
--START       |2022-01-01 00:00:00.000|2022-01-01 00:00:00.000|         7432.29|
--START       |2022-01-01 00:00:00.000|2022-02-01 00:00:00.000|         6632.83|
--START       |2022-01-01 00:00:00.000|2022-03-01 00:00:00.000|         7243.57|
--START       |2022-01-01 00:00:00.000|2022-04-01 00:00:00.000|         7186.25|
--START       |2022-01-01 00:00:00.000|2022-05-01 00:00:00.000|         7281.69|
--START       |2022-01-01 00:00:00.000|2022-06-01 00:00:00.000|         7224.66|
--START       |2022-01-01 00:00:00.000|2022-07-01 00:00:00.000|         7414.92|
--START       |2022-01-01 00:00:00.000|                       |        50416.21|
--START       |                       |                       |       404248.19|
--YEAR        |2021-01-01 00:00:00.000|2021-02-01 00:00:00.000|        50144.72|
--YEAR        |2021-01-01 00:00:00.000|2021-03-01 00:00:00.000|        56049.72|
--YEAR        |2021-01-01 00:00:00.000|2021-04-01 00:00:00.000|        53807.41|
--YEAR        |2021-01-01 00:00:00.000|2021-05-01 00:00:00.000|        54908.59|
--YEAR        |2021-01-01 00:00:00.000|2021-06-01 00:00:00.000|        53086.57|
--YEAR        |2021-01-01 00:00:00.000|2021-07-01 00:00:00.000|        54935.11|
--YEAR        |2021-01-01 00:00:00.000|2021-08-01 00:00:00.000|        270026.2|
--YEAR        |2021-01-01 00:00:00.000|2021-09-01 00:00:00.000|       258737.17|
--YEAR        |2021-01-01 00:00:00.000|                       |       851695.49|
--YEAR        |2022-01-01 00:00:00.000|                       |                |
--YEAR        |                       |                       |       851695.49|
```