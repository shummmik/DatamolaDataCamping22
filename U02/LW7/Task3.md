# Task 3

```sql
CREATE MATERIALIZED VIEW LOG ON  U_DW_SUBSTRICTIONS.T_SUBSCRIPTIONS_USER_F
WITH rowid, SEQUENCE (ID_SUBSCRIPTIONS, ID_USER, PAYMENT, START_DTM, END_DTM)
INCLUDING NEW VALUES;



CREATE MATERIALIZED VIEW  U_DW_SUBSTRICTIONS.MONTHLY_SUBSTRICTIONS_REP_SUM
BUILD IMMEDIATE 
REFRESH COMPLETE
    NEXT SYSDATE + 5/1440
AS 
WITH TMP_T
AS
(
select TSS.NAME SUBSCRIPTION, 
    trunc(tsuf.START_DTM, 'YYYY')      AS YEAR,
    TO_CHAR(tsuf.START_DTM, 'MM')      AS MONTH,
    'MONTH' PERIOD,
    SUM(tsuf.PAYMENT) AS PROFIT_BY_MOUNTH
  
    from U_DW_SUBSTRICTIONS.T_SUBSCRIPTIONS_USER_F tsuf 
    inner join 
    (SELECT *
    FROM
    U_DW_SUBSTRICTIONS.T_SUBSCRIPTIONS TS
    INNER JOIN 
    U_DW_SUBSTRICTIONS.T_SUBSCRIPTIONS_NAME TSN
    ON 
    TS.ID_SUBSCRIPTIONS_NAME=TSN.ID_SUBSCRIPTIONS_NAME)
    TSS 
    on 
    tsuf.ID_SUBSCRIPTIONS=TSS.ID_SUBSCRIPTIONS
    GROUP BY 
        TSS.NAME, 
        trunc(tsuf.START_DTM, 'YYYY'),
         TO_CHAR(tsuf.START_DTM, 'MM') 
    ORDER BY 
    SUBSCRIPTION, 
    YEAR,
    MONTH
)

SELECT
    SUBSCRIPTION, 
    YEAR,
    MONTH,
    PERIOD,
    PROFIT_BY_MOUNTH
FROM
TMP_T
 MODEL 
    PARTITION BY (SUBSCRIPTION)
    DIMENSION BY (YEAR, MONTH, PERIOD)
    MEASURES (PROFIT_BY_MOUNTH)
    RULES (
        PROFIT_BY_MOUNTH[FOR YEAR IN (SELECT DISTINCT YEAR FROM TMP_T), NULL, 'YEAR'] = SUM(PROFIT_BY_MOUNTH)[CV(YEAR), ANY, 'MONTH'],
        PROFIT_BY_MOUNTH[NULL, NULL, 'ALL'] = SUM(PROFIT_BY_MOUNTH)[ANY, NULL, 'YEAR']
    )
ORDER BY 
    SUBSCRIPTION,
    YEAR,
    MONTH
    ;

SELECT * FROM U_DW_SUBSTRICTIONS.MONTHLY_SUBSTRICTIONS_REP_SUM;
```

| SUBSCRIPTION | YEAR | MONTH | PERIOD | PROFIT\_BY\_MOUNTH |
| :--- | :--- | :--- | :--- | :--- |
| MEDIUM | 2021-01-01 00:00:00 | 02 | MONTH | 9638.84 |

```sql

UPDATE U_DW_SUBSTRICTIONS.T_SUBSCRIPTIONS_USER_F 
SET
    PAYMENT = PAYMENT*0.1
WHERE START_DTM < TO_DATE('01/03/2021', 'DD/MM/YYYY');
COMMIT;

--AFTER 5 MIN
SELECT * FROM U_DW_SUBSTRICTIONS.MONTHLY_SUBSTRICTIONS_REP_SUM;
```
| SUBSCRIPTION | YEAR | MONTH | PERIOD | PROFIT\_BY\_MOUNTH |
| :--- | :--- | :--- | :--- | :--- |
| MEDIUM | 2021-01-01 00:00:00 | 02 | MONTH | 963.884 |